{"version":3,"file":"index.modern.js","sources":["../src/lib/jobRunner.ts","../src/lib/createWorkerBlobUrl.ts","../src/lib/remoteDepsParser.ts","../src/lib/status.ts","../src/useWorker.ts","../src/hook/useDeepCallback.ts"],"sourcesContent":["/* eslint-disable no-restricted-globals */\nimport { TRANSFERABLE_TYPE } from 'src/useWorker'\n\ninterface JOB_RUNNER_OPTIONS {\n  fn: Function,\n  transferable: TRANSFERABLE_TYPE\n}\n\n/**\n * This function accepts as a parameter a function \"userFunc\"\n * And as a result returns an anonymous function.\n * This anonymous function, accepts as arguments,\n * the parameters to pass to the function \"useArgs\" and returns a Promise\n * This function can be used as a wrapper, only inside a Worker\n * because it depends by \"postMessage\".\n *\n * @param {Function} userFunc {Function} fn the function to run with web worker\n *\n * @returns {Function} returns a function that accepts the parameters\n * to be passed to the \"userFunc\" function\n */\nconst jobRunner = (options: JOB_RUNNER_OPTIONS): Function => (e: MessageEvent) => {\n  const [userFuncArgs] = e.data as [any[]]\n  return Promise.resolve(options.fn(...userFuncArgs))\n    .then(result => {\n      const isTransferable = (val: any) => (\n        ('ArrayBuffer' in self && val instanceof ArrayBuffer)\n        || ('MessagePort' in self && val instanceof MessagePort)\n        || ('ImageBitmap' in self && val instanceof ImageBitmap)\n        || ('OffscreenCanvas' in self && val instanceof OffscreenCanvas)\n      )\n      const transferList: any[] = options.transferable === 'auto' && isTransferable(result) ? [result] : []\n      // @ts-ignore\n      postMessage(['SUCCESS', result], transferList)\n    })\n    .catch(error => {\n      // @ts-ignore\n      postMessage(['ERROR', error])\n    })\n}\n\nexport default jobRunner\n","// import isoworker from 'isoworker'\nimport { TRANSFERABLE_TYPE } from '../useWorker'\nimport jobRunner from './jobRunner'\nimport remoteDepsParser from './remoteDepsParser'\n\n/**\n * Converts the \"fn\" function into the syntax needed to be executed within a web worker\n *\n * @param {Function} fn the function to run with web worker\n * @param {Array.<String>} deps array of strings, imported into the worker through \"importScripts\"\n *\n * @returns {String} a blob url, containing the code of \"fn\" as a string\n *\n * @example\n * createWorkerBlobUrl((a,b) => a+b, [])\n * // return \"onmessage=return Promise.resolve((a,b) => a + b)\n * .then(postMessage(['SUCCESS', result]))\n * .catch(postMessage(['ERROR', error])\"\n */\nconst createWorkerBlobUrl = (\n  fn: Function, deps: string[], transferable: TRANSFERABLE_TYPE, /* localDeps: () => unknown[], */\n) => {\n  // const [context] = isoworker.createContext(localDeps)\n  const blobCode = `\n    ${remoteDepsParser(deps)};\n    onmessage=(${jobRunner})({\n      fn: (${fn}),\n      transferable: '${transferable}'\n    })\n  `\n  const blob = new Blob([blobCode], { type: 'text/javascript' })\n  const url = URL.createObjectURL(blob)\n  return url\n}\n\nexport default createWorkerBlobUrl\n","/**\n *\n * Concatenates the remote dependencies into a comma separated string.\n * this string will then be passed as an argument to the \"importScripts\" function\n *\n * @param {Array.<String>}} deps array of string\n * @returns {String} a string composed by the concatenation of the array\n * elements \"deps\" and \"importScripts\".\n *\n * @example\n * remoteDepsParser(['http://js.com/1.js', 'http://js.com/2.js']) // importScripts('http://js.com/1.js', 'http://js.com/2.js')\n */\nconst remoteDepsParser = (deps: string[]) => {\n  if (deps.length === 0) return ''\n\n  const depsString = (deps.map(dep => `'${dep}'`)).toString()\n  return `importScripts(${depsString})`\n}\n\nexport default remoteDepsParser\n","export enum WORKER_STATUS {\n  PENDING = 'PENDING',\n  SUCCESS = 'SUCCESS',\n  RUNNING = 'RUNNING',\n  ERROR = 'ERROR',\n  TIMEOUT_EXPIRED = 'TIMEOUT_EXPIRED',\n}\n\nexport default WORKER_STATUS\n","import React from \"react\";\nimport createWorkerBlobUrl from \"./lib/createWorkerBlobUrl\";\nimport WORKER_STATUS from \"./lib/status\";\nimport { useDeepCallback } from \"./hook/useDeepCallback\";\n\ntype WorkerController = {\n  status: WORKER_STATUS;\n  kill: Function;\n};\n\nexport enum TRANSFERABLE_TYPE {\n  AUTO = \"auto\",\n  NONE = \"none\",\n}\n\ntype Options = {\n  timeout?: number;\n  remoteDependencies?: string[];\n  autoTerminate?: boolean;\n  transferable?: TRANSFERABLE_TYPE;\n  // localDependencies?: () => unknown[];\n};\n\nconst PROMISE_RESOLVE = \"resolve\";\nconst PROMISE_REJECT = \"reject\";\nconst DEFAULT_OPTIONS: Options = {\n  timeout: undefined,\n  remoteDependencies: [],\n  autoTerminate: true,\n  transferable: TRANSFERABLE_TYPE.AUTO,\n  // localDependencies: () => [],\n};\n\n/**\n *\n * @param {Function} fn the function to run with web worker\n * @param {Object} options useWorker option params\n */\nexport const useWorker = <T extends (...fnArgs: any[]) => any>(\n  fn: T,\n  options: Options = DEFAULT_OPTIONS\n) => {\n  const [workerStatus, _setWorkerStatus] = React.useState<WORKER_STATUS>(\n    WORKER_STATUS.PENDING\n  );\n  const worker = React.useRef<Worker & { _url?: string }>();\n  const isRunning = React.useRef(false);\n  const promise = React.useRef<{\n    [PROMISE_REJECT]?: (result: ReturnType<T> | ErrorEvent) => void;\n    [PROMISE_RESOLVE]?: (result: ReturnType<T>) => void;\n  }>({});\n  const timeoutId = React.useRef<number>();\n\n  const setWorkerStatus = React.useCallback((status: WORKER_STATUS) => {\n    isRunning.current = status === WORKER_STATUS.RUNNING;\n    _setWorkerStatus(status);\n  }, []);\n\n  const killWorker = React.useCallback(() => {\n    if (worker.current?._url) {\n      worker.current.terminate();\n      URL.revokeObjectURL(worker.current._url);\n      promise.current = {};\n      worker.current = undefined;\n      window.clearTimeout(timeoutId.current);\n    }\n  }, []);\n\n  const onWorkerEnd = React.useCallback(\n    (status: WORKER_STATUS) => {\n      const terminate =\n        options.autoTerminate != null\n          ? options.autoTerminate\n          : DEFAULT_OPTIONS.autoTerminate;\n\n      if (terminate) {\n        killWorker();\n      }\n      setWorkerStatus(status);\n    },\n    [options.autoTerminate, killWorker, setWorkerStatus]\n  );\n\n  const generateWorker = useDeepCallback(() => {\n    const {\n      remoteDependencies = DEFAULT_OPTIONS.remoteDependencies,\n      timeout = DEFAULT_OPTIONS.timeout,\n      transferable = DEFAULT_OPTIONS.transferable,\n      // localDependencies = DEFAULT_OPTIONS.localDependencies,\n    } = options;\n\n    const blobUrl = createWorkerBlobUrl(\n      fn,\n      remoteDependencies!,\n      transferable! /*, localDependencies!*/\n    );\n    const newWorker: Worker & { _url?: string } = new Worker(blobUrl);\n    newWorker._url = blobUrl;\n\n    newWorker.onmessage = (e: MessageEvent) => {\n      const [status, result] = e.data as [WORKER_STATUS, ReturnType<T>];\n\n      switch (status) {\n        case WORKER_STATUS.SUCCESS:\n          promise.current[PROMISE_RESOLVE]?.(result);\n          onWorkerEnd(WORKER_STATUS.SUCCESS);\n          break;\n        default:\n          promise.current[PROMISE_REJECT]?.(result);\n          onWorkerEnd(WORKER_STATUS.ERROR);\n          break;\n      }\n    };\n\n    newWorker.onerror = (e: ErrorEvent) => {\n      promise.current[PROMISE_REJECT]?.(e);\n      onWorkerEnd(WORKER_STATUS.ERROR);\n    };\n\n    if (timeout) {\n      timeoutId.current = window.setTimeout(() => {\n        killWorker();\n        setWorkerStatus(WORKER_STATUS.TIMEOUT_EXPIRED);\n      }, timeout);\n    }\n    return newWorker;\n  }, [fn, options, killWorker]);\n\n  const callWorker = React.useCallback(\n    (...workerArgs: Parameters<T>) => {\n      const { transferable = DEFAULT_OPTIONS.transferable } = options;\n      return new Promise<ReturnType<T>>((resolve, reject) => {\n        promise.current = {\n          [PROMISE_RESOLVE]: resolve,\n          [PROMISE_REJECT]: reject,\n        };\n        const transferList: any[] =\n          transferable === TRANSFERABLE_TYPE.AUTO\n            ? workerArgs.filter(\n                (val: any) =>\n                  (\"ArrayBuffer\" in window && val instanceof ArrayBuffer) ||\n                  (\"MessagePort\" in window && val instanceof MessagePort) ||\n                  (\"ImageBitmap\" in window && val instanceof ImageBitmap) ||\n                  (\"OffscreenCanvas\" in window &&\n                    val instanceof OffscreenCanvas)\n              )\n            : [];\n\n        worker.current?.postMessage([[...workerArgs]], transferList);\n\n        setWorkerStatus(WORKER_STATUS.RUNNING);\n      });\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    },\n    [setWorkerStatus]\n  );\n\n  const workerHook = React.useCallback(\n    (...fnArgs: Parameters<T>) => {\n      const terminate =\n        options.autoTerminate != null\n          ? options.autoTerminate\n          : DEFAULT_OPTIONS.autoTerminate;\n\n      if (isRunning.current) {\n        /* eslint-disable-next-line no-console */\n        console.error(\n          \"[useWorker] You can only run one instance of the worker at a time, if you want to run more than one in parallel, create another instance with the hook useWorker(). Read more: https://github.com/alewin/useWorker\"\n        );\n        return Promise.reject();\n      }\n      if (terminate || !worker.current) {\n        worker.current = generateWorker();\n      }\n\n      return callWorker(...fnArgs);\n    },\n    [options.autoTerminate, generateWorker, callWorker]\n  );\n\n  const workerController = {\n    status: workerStatus,\n    kill: killWorker,\n  };\n\n  React.useEffect(\n    () => () => {\n      killWorker();\n    },\n    [killWorker]\n  );\n\n  return [workerHook, workerController, worker.current] as [\n    typeof workerHook,\n    WorkerController,\n    any\n  ];\n};\n","import React, { DependencyList } from 'react'\nimport dequal from 'dequal'\n\nexport const useDeepCallback = <T extends (...args: any[]) => any>(\n  callback: T, dependencies: DependencyList,\n) => {\n  const prevDependencies = React.useRef<DependencyList>(dependencies)\n  const areDeepsEqual = dequal(prevDependencies.current, dependencies)\n  if (!areDeepsEqual) {\n    prevDependencies.current = dependencies\n  }\n\n  return React.useCallback(callback, prevDependencies.current)\n}\n"],"names":["jobRunner","options","e","userFuncArgs","data","Promise","resolve","fn","then","result","transferList","transferable","val","self","ArrayBuffer","MessagePort","ImageBitmap","OffscreenCanvas","postMessage","catch","error","createWorkerBlobUrl","deps","blobCode","length","map","dep","toString","remoteDepsParser","blob","Blob","type","URL","createObjectURL","WORKER_STATUS","TRANSFERABLE_TYPE","DEFAULT_OPTIONS","timeout","undefined","remoteDependencies","autoTerminate","AUTO","useWorker","workerStatus","_setWorkerStatus","React","useState","PENDING","worker","useRef","isRunning","promise","timeoutId","setWorkerStatus","useCallback","status","current","RUNNING","killWorker","_worker$current","_url","terminate","revokeObjectURL","window","clearTimeout","onWorkerEnd","generateWorker","callback","dependencies","prevDependencies","dequal","blobUrl","newWorker","Worker","onmessage","SUCCESS","ERROR","onerror","setTimeout","TIMEOUT_EXPIRED","useDeepCallback","callWorker","workerArgs","reject","filter","workerHook","fnArgs","console","workerController","kill","useEffect"],"mappings":"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"}